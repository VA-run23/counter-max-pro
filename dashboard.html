<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Counter Max</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <h3 id="welcome">Dashboard</h3>
      <div>
        <button id="logout" class="btn btn-outline-secondary">Logout</button>
      </div>
    </div>

    <div id="content" class="mt-4">Loading...</div>
  </div>

  <script>
    async function fetchJSON(url) {
      const resp = await fetch(url, { credentials: 'include' });
      if (!resp.ok) throw new Error('fetch failed');
      return resp.json();
    }

    async function load() {
      try {
        const data = await fetchJSON('/api/dashboard');
        document.getElementById('welcome').innerText = `Welcome, ${data.user.name}`;

        const container = document.getElementById('content');
        if (!data.tasks || data.tasks.length === 0) {
          container.innerHTML = '<div class="alert alert-info">No tasks selected yet. Please set up tasks.</div>';
          return;
        }

        let html = '<div class="row">';
        data.tasks.forEach(t => {
          html += `<div class="col-12 col-md-6 col-lg-4 mb-3"><div class="card p-3"><h5>${t.name}</h5><p>Completed today: ${t.completed ? 'Yes' : 'No'}</p><p>Current streak: ${t.currentStreak}</p></div></div>`;
        });
        html += '</div>';
        container.innerHTML = html;
      } catch (err) {
        document.getElementById('content').innerHTML = '<div class="alert alert-danger">Not authenticated or failed to load dashboard. Please login.</div>';
      }
    }

    document.getElementById('logout').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST', credentials: 'include' });
      window.location.href = '/userRegistration1.html';
    });

    load();
  </script>
</body>
</html>
